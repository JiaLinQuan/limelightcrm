jQuery(document).ready(function(a){function p(){q(),u(),w()}function q(){a(".crm_dropdown_list").length>0&&(i=a(".crm_dropdown_list").prop("id"),j=a(".crm_dropdown_list").html())}function r(b){a(".retention_alert").html(b),a(".retention_alert").fadeIn(1e3,function(){a(".retention_alert").fadeOut(3e3)})}function s(b,d,e){"list"==b&&(e?a(".retention_waiting").html(c):a(".retention_waiting").html(""))}function t(b){a(".aff_item_by_"+b).each(function(b){a(this).remove()}),a("#waittr_"+b).remove(),a(".subaff_item_by_"+b).each(function(b){a(this).remove()})}function u(){var b=new Date,c=v(b.getFullYear(),b.getMonth()+1,b.getDate());if("date_today"==k)l=c,m=c;else if("date_yesterday"==k)b.setDate(b.getDate()-1),l=v(b.getFullYear(),b.getMonth()+1,b.getDate()),m=v(b.getFullYear(),b.getMonth()+1,b.getDate());else if("date_thisweek"==k){var d=b.getDate()+1;d-=0==b.getDay()?7:b.getDay(),b.setDate(d),l=v(b.getFullYear(),b.getMonth()+1,b.getDate()),m=c}else if("date_thismonth"==k)l=v(b.getFullYear(),b.getMonth()+1,1),m=c;else if("date_thisyear"==k)l=v(b.getFullYear(),1,1),m=c;else if("date_lastweek"==k){var d=b.getDate()+1-7;d-=0==b.getDay()?7:b.getDay(),b.setDate(d),l=v(b.getFullYear(),b.getMonth()+1,b.getDate()),d=b.getDate()+6,b.setDate(d),m=v(b.getFullYear(),b.getMonth()+1,b.getDate())}else"date_custom"==k&&(l="",m="");a("#from_date").val(l),a("#to_date").val(m)}function v(a,b,c){var d=c,e=b,f=a;return d<10&&(d="0"+d),e<10&&(e="0"+e),e+"/"+d+"/"+f}function w(){return""==a("#from_date").val()?void r("Please select FROM DATE."):""==a("#to_date").val()?void r("Please select TO DATE."):(s("list","",!0),void a.ajax({type:"GET",url:"../daemon/ajax/retention_list.php",data:{crm_id:i,from_date:a("#from_date").val(),to_date:a("#to_date").val(),cycle:n},success:function(b){s("list","",!1);var c=jQuery.parseJSON(b);if("error"==c[0])r("Cannot load retention information.");else{o=c[2].cycle;var d=c[2].report.length,e="",f="",g="";e="<tr>",e+='<th rowspan="2" style="vertical-align:middle"><button type="button" class="btn btn-link btn-sm btn_campaign_head"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span></button></th>',e+='<th rowspan="2" style="vertical-align:middle"></th>',e+='<th rowspan="2" style="vertical-align:middle">Campaign (ID) Name</th>',e+='<th colspan="6" style="border: 1px solid #dadada">Initial Cycle</th>';for(var h=1;h<o;h++)e+='<th colspan="6" style="border: 1px solid #dadada">Subscription Cycle '+h+"</th>";e+="</tr>",e+="<tr>",e+='<th style="border-left: 1px solid #dadada">Gross Orders</th>',e+="<th>Net Approved</th>",e+="<th>Void/Full Refund</th>",e+="<th>Partial Refund</th>",e+="<th>Void/Refund Revenue</th>",e+="<th>Approval Rate</th>";for(var h=1;h<o;h++)e+='<th style="border-left: 1px solid #dadada">Gross Orders</th>',e+="<th>Net Approved</th>",e+="<th>Void/Full Refund</th>",e+="<th>Partial Refund</th>",e+="<th>Void/Refund Revenue</th>",e+="<th>Conversion</th>";if(e+="</tr>",a(".table_retention_head").html(e),0==d)return void r("There is no any retention information.");e="";for(var h=0;h<d;h++){e+='<tr id="camprow_'+c[2].report[h][0]+'" class="camp_tr">',"-1"==c[2].report[h][0]?(f="<b>",g="</b>",e+="<td></td>",e+="<td></td>",e+="<td>"+f+"Total"+g+"</td>"):(f="",g="",e+="yes"==c[2].report[h][2+6*o]?'<td><button type="button" class="btn btn-link btn-sm btn_campaign_expand" id="camp_'+c[2].report[h][0]+'"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span></button></td>':"<td></td>",e+="<td></td>",e+="<td>("+c[2].report[h][0]+") "+c[2].report[h][1]+"</td>"),e+='<td style="border-left: 1px solid #dadada">'+f+c[2].report[h][2]+g+"</td>",e+="<td>"+f+c[2].report[h][3]+g+"</td>",e+="<td>"+f+c[2].report[h][4]+g+"</td>",e+="<td>"+f+c[2].report[h][5]+g+"</td>",e+="<td>"+f+"$"+c[2].report[h][6]+g+"</td>",e+="<td>"+f+c[2].report[h][7]+"%"+g+"</td>";for(var i=1;i<o;i++)e+='<td style="border-left: 1px solid #dadada">'+f+c[2].report[h][6*i+2]+g+"</td>",e+="<td>"+f+c[2].report[h][6*i+3]+g+"</td>",e+="<td>"+f+c[2].report[h][6*i+4]+g+"</td>",e+="<td>"+f+c[2].report[h][6*i+5]+g+"</td>",e+="<td>"+f+"$"+c[2].report[h][6*i+6]+g+"</td>",e+="<td>"+f+c[2].report[h][6*i+7]+"%"+g+"</td>";e+="</tr>"}a(".table_retention_body").html(e)}},failure:function(a){s("list","",!1),r("Cannot load retention information.")}}))}function x(d){b=!0,a.ajax({type:"GET",url:"../daemon/ajax/retention_aid.php",data:{crm_id:i,campaign_id:d,from_date:a("#from_date").val(),to_date:a("#to_date").val(),cycle:n},success:function(d){b=!1;var f=jQuery.parseJSON(d);if("error"==f[0])return void a("#waittd_"+f[1]).html(e);var g="",j=f[1];o=f[2].cycle;for(var k=0;k<f[2].report.length;k++){g=0==k?'<tr id="affrow_'+j+"_"+f[2].report[k][0]+'" style="border: 2px solid #b3b3b3; border-top:none;" class="aff_item_by_'+j+'">':'<tr id="affrow_'+j+"_"+f[2].report[k][0]+'" style="border: 2px solid #b3b3b3; border-top:none; border-bottom:none;" class="aff_item_by_'+j+'">',g+="<td></td>",g+='<td id="affmark_'+j+"_"+f[2].report[k][0]+'">'+c+"</td>",g+="<td>("+f[2].report[k][0]+") "+f[2].report[k][1]+"</td>",g+='<td style="border-left: 1px solid #dadada">'+f[2].report[k][2]+"</td>",g+="<td>"+f[2].report[k][3]+"</td>",g+="<td>"+f[2].report[k][4]+"</td>",g+="<td>"+f[2].report[k][5]+"</td>",g+="<td>$"+f[2].report[k][6]+"</td>",g+="<td>"+f[2].report[k][7]+"%</td>";for(var l=1;l<o;l++)g+='<td style="border-left: 1px solid #dadada">'+f[2].report[k][6*l+2]+"</td>",g+="<td>"+f[2].report[k][6*l+3]+"</td>",g+="<td>"+f[2].report[k][6*l+4]+"</td>",g+="<td>"+f[2].report[k][6*l+5]+"</td>",g+="<td>$"+f[2].report[k][6*l+6]+"</td>",g+="<td>"+f[2].report[k][6*l+7]+"%</td>";g+="</tr>",a("#camprow_"+j).closest("tr").after(g),a("#waittr_"+j).remove(),y(j,f[2].report[k][0],o,0==k)}},failure:function(a){b=!1,r("Cannot load affiliate information.")}})}function y(b,c,d,f){a.ajax({type:"GET",url:"../daemon/ajax/retention_sub_aid.php",data:{crm_id:i,campaign_id:b,affiliate_id:c,from_date:a("#from_date").val(),to_date:a("#to_date").val(),cycle:n},success:function(b){var c=jQuery.parseJSON(b);if("error"==c[0])return void a("#affmark_"+c[1]+"_"+c[2]).html(e);var g="",i=c[1],j=c[2];a("#affmark_"+i+"_"+j).html(h),c[3].report.length>0&&f&&a("#affrow_"+i+"_"+j).css("border-bottom","none");for(var k=0;k<c[3].report.length;k++){g=0==k&&f?'<tr id="subaff_'+c[3].report[k][0]+'" class="subaff_item_by_'+i+" esubaff_"+i+"_"+j+'" style="border: 2px solid #b3b3b3; border-top:none;">':'<tr id="subaff_'+c[3].report[k][0]+'" class="subaff_item_by_'+i+" esubaff_"+i+"_"+j+'" style="border: 2px solid #b3b3b3; border-top:none; border-bottom:none;">',g+="<td></td>",g+="<td></td>",g+="<td>("+c[3].report[k][0]+") "+c[3].report[k][1]+"</td>",g+='<td style="border-left: 1px solid #dadada">'+c[3].report[k][2]+"</td>",g+="<td>"+c[3].report[k][3]+"</td>",g+="<td>"+c[3].report[k][4]+"</td>",g+="<td>"+c[3].report[k][5]+"</td>",g+="<td>$"+c[3].report[k][6]+"</td>",g+="<td>"+c[3].report[k][7]+"%</td>";for(var l=1;l<d;l++)g+='<td style="border-left: 1px solid #dadada">'+c[3].report[k][6*l+2]+"</td>",g+="<td>"+c[3].report[k][6*l+3]+"</td>",g+="<td>"+c[3].report[k][6*l+4]+"</td>",g+="<td>"+c[3].report[k][6*l+5]+"</td>",g+="<td>$"+c[3].report[k][6*l+6]+"</td>",g+="<td>"+c[3].report[k][6*l+7]+"%</td>";g+="</tr>",a("#affrow_"+i+"_"+j).closest("tr").after(g)}},failure:function(a){}})}var b=!1,c='<img src="../images/loading.gif" style="width:22px;height:22;">',e='<span class="glyphicon glyphicon-remove-sign" aria-hidden="true" style="color: #ffa5a5"></span>',f='<span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>',g='<span class="glyphicon glyphicon-minus-sign" aria-hidden="true" style="color: #ffa5a5"></span>',h='<span class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="color: #b3b3b3"></span>',i=-1,j="",k="date_thisweek",l="",m="",n=1,o=1;p(),a(".crm_dropdown_menu li").on("click",function(b){j=a(this).text(),i=a(this).find("a").attr("id"),a(".crm_toggle_button").html(j+' <span class="caret"></span>')}),a(".input-daterange").datepicker({}),a(".date_dropdown_menu li").on("click",function(b){var c=a(this).text();k=a(this).find("a").attr("id"),a(".date_toggle_button").html(c+' <span class="caret"></span>'),u()}),a(".cycle_dropdown_menu li").on("click",function(b){n=a(this).text(),cycle_id=a(this).prop("id").substring(6),a(".cycle_toggle_button").html(n+' <span class="caret"></span>')}),a(".retention_search_button").click(function(){w()}),a(".table_retention_body").on("click",".btn_campaign_expand",function(d){if(!b){var e="",h=a(this).html(),i=h.indexOf("glyphicon-plus-sign")!=-1,j=a(this).prop("id").substring(5);t(j),i?(a(this).html(g),e='<tr id="waittr_'+j+'" style="border: 2px solid #b3b3b3; border-top:none;">',e+="<td></td>",e+="<td></td>",e+="<td>"+c+"</td>",e+='<td id="waittd_'+j+'" colspan="'+6*o+'"></td>',e+="</tr>",a(this).closest("tr").after(e),x(j)):a(this).html(f)}}),a(".table_retention_head").on("click",".btn_campaign_head",function(d){if(!b){var e="",h=a(this).html(),i=h.indexOf("glyphicon-plus-sign")!=-1;a(".btn_campaign_expand").each(function(b){var d=a(this).prop("id").substring(5);t(d),i?(a(this).html(g),e='<tr id="waittr_'+d+'" style="border: 2px solid #b3b3b3; border-top:none;">',e+="<td></td>",e+="<td></td>",e+="<td>"+c+"</td>",e+='<td id="waittd_'+d+'" colspan="'+6*o+'"></td>',e+="</tr>",a(this).closest("tr").after(e),x(d)):a(this).html(f)}),i?a(this).html(g):a(this).html(f)}})});